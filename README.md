# Qt 即时通讯系统

一个基于Qt框架开发的多人即时通讯系统（类似微信/QQ精简版），支持用户注册登录、联系人管理、单聊/群聊等功能。

## 功能特性

- ✅ **用户注册与登录**：支持本地数据库和服务器双重验证
- ✅ **联系人列表与分组**：树形结构展示联系人，支持分组管理
- ✅ **单聊/群聊窗口**：独立的聊天窗口，支持多标签页管理
- ✅ **消息列表 Model/View**：使用Qt Model/View架构展示消息
- ✅ **SQLite本地缓存**：自动保存聊天记录和联系人信息
- ✅ **TCP长连接**：支持TCP长连接通信，自动心跳和重连机制
- ✅ **后台线程**：心跳线程维护连接状态

## 技术架构

### 模块划分

1. **GUI模块**：主窗口、登录对话框、聊天窗口、联系人列表
2. **MV模块**：MessageModel实现Model/View架构
3. **DB模块**：DatabaseManager管理SQLite数据库
4. **NET模块**：NetworkManager处理TCP网络通信
5. **THR模块**：HeartbeatThread维护心跳连接

### 项目结构

```
chat/
├── chat.pro                 # Qt项目文件
├── main.cpp                 # 程序入口
├── mainwindow.h/cpp/ui      # 主窗口
├── logindialog.h/cpp/ui     # 登录/注册对话框
├── chatwindow.h/cpp/ui      # 聊天窗口
├── contactlistwidget.h/cpp  # 联系人列表组件
├── databasemanager.h/cpp    # 数据库管理类
├── networkmanager.h/cpp     # 网络通信类
├── messagemodel.h/cpp       # 消息模型类
├── heartbeatthread.h/cpp   # 心跳线程类
└── resources.qrc            # 资源文件

```

## 编译与运行

### 环境要求

- Qt 5.12 或更高版本
- C++17 编译器
- Qt模块：core, gui, network, sql, widgets

### 编译步骤

1. 使用Qt Creator打开 `chat.pro` 文件
2. 配置构建套件（Kit）
3. 点击"构建"按钮或按 `Ctrl+B`
4. 运行程序（`F5` 或点击运行按钮）

### 首次运行

1. 程序启动后会显示登录/注册对话框
2. 首次使用需要注册账号：
   - 切换到"注册"标签页
   - 输入用户名、密码（至少6位）、昵称
   - 点击"注册"按钮
3. 注册成功后会自动登录，进入主界面

## 使用说明

### 登录/注册

- **服务器设置**：默认连接 `127.0.0.1:8888`，可在登录界面修改
- **离线模式**：如果无法连接服务器，可以使用本地数据库登录（仅限已注册用户）

### 添加联系人

1. 点击联系人列表下方的"添加联系人"按钮
2. 输入联系人ID、名称和分组名称
3. 联系人会添加到指定分组下

### 发送消息

1. 双击联系人打开聊天窗口
2. 在底部输入框输入消息
3. 点击"发送"按钮或按回车键发送
4. 消息会自动保存到本地数据库

### 群聊功能

- 添加群组联系人时，将"是否群组"设置为true
- 群聊消息会显示发送者ID
- 支持群组消息的本地缓存

## 数据库结构

### users表
- `user_id`: 用户ID（主键）
- `username`: 用户名（唯一）
- `password`: 密码
- `nickname`: 昵称
- `is_online`: 在线状态
- `created_at`: 创建时间

### contacts表
- `id`: 记录ID（主键）
- `user_id`: 用户ID
- `contact_id`: 联系人ID
- `contact_name`: 联系人名称
- `group_name`: 分组名称
- `is_group`: 是否群组
- `last_message_time`: 最后消息时间

### messages表
- `message_id`: 消息ID（主键）
- `from_user_id`: 发送者ID
- `to_user_id`: 接收者ID
- `content`: 消息内容
- `message_type`: 消息类型（0:文本）
- `is_group`: 是否群组消息
- `timestamp`: 时间戳

## 网络协议

### 消息格式

采用JSON格式，包含以下字段：
- `type`: 消息类型（1:登录, 2:注册, 3:文本消息, 4:心跳, 5:确认, 6:获取联系人, 7:添加联系人, 8:群组消息）
- `data`: 消息数据（JSON对象）

### TCP协议

- 消息前4字节为消息长度（大端序）
- 后续为JSON数据
- 支持自动重连和心跳机制（30秒间隔）

## 注意事项

1. **服务器端**：本项目仅包含客户端代码，需要单独实现服务器端程序
2. **密码安全**：当前版本密码以明文存储，生产环境应使用加密算法
3. **消息加密**：网络传输未加密，敏感信息请自行加密
4. **数据库位置**：数据库文件保存在应用数据目录，Windows下通常在 `%APPDATA%/chat/chat.db`

## 扩展功能建议

- [ ] 文件传输功能
- [ ] 图片消息支持
- [ ] 消息加密
- [ ] 用户头像显示
- [ ] 消息撤回功能
- [ ] 离线消息推送
- [ ] WebSocket支持

## 许可证

本项目仅供学习和参考使用。
